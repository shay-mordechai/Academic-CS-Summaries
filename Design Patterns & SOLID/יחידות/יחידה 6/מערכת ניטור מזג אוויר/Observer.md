## 2. Observer Pattern (צופה)

Observer היא תבנית עיצוב **התנהגותית**.

### מטרה ויישום (ניתוק מהמסך)

### הבעיה שנותרה

תזכורת: בעיית [[DIP]] של המחלקה המופשטת - הפכה להיות תלויה ישירות במחלקה הקונקרטית MonitoringScreen.
היא פותרת את **הפרת [[DIP]]** שבה החיישן (ספק המידע) היה תלוי ישירות ב-`MonitoringScreen` (הצרכן).

התרשים לפני Observer:
![](Summeries/עיצוב/media/media/image77.png)
- **החיישנים** (כמו `TemperatureSensor`) הפכו ל-**Observable** ("נצפה"), המנהלים רשימה של צופים (Observers).
- **המסך** (`MonitoringScreen`) הופך ל**צרכן**.

אנלוגיה: ערוץ יוטיוב.

- היוטיובר (Observable/Subject): הוא "הנושא". כשהוא מעלה סרטון חדש (משנה את המצב שלו), הוא רוצה לעדכן את כל העוקבים.
    
- העוקבים (Observers): הם "הצופים". הם נרשמו לערוץ כדי לקבל עדכונים.
    

היוטיובר לא מכיר כל עוקב באופן אישי. הוא פשוט שולח התראה כללית, ופלטפורמת יוטיוב (מנגנון ה-Observer) דואגת להפיץ אותה לכל מי שנרשם.

### המבנה ב-UML
![](Summeries/עיצוב/media/media/image97.png)
![](observer-uml.png)
  

- Observable (או Subject): מחזיק רשימה של Observers. יש לו מתודות addObserver, removeObserver ו-notifyObservers.
    

Observer: ממשק עם מתודה אחת, בדרך כלל update(data), שמופעלת כאשר ה-Observable שולח עדכון.

 תרשים לאחר Observer רגיל:
![](Summeries/עיצוב/media/media/image36.png)
- החיישן (TemperatureSensor): הוא ה-Observable. כשהטמפרטורה שהוא מודד משתנה, הוא קורא ל-notifyObservers.
    
- התצוגה (MonitoringScreen): היא ה-Observer. היא נרשמת לקבל עדכונים מהחיישן. כשהיא מקבלת עדכון דרך מתודת update, היא מציגה את הטמפרטורה החדשה על המסך.
    

הוספת חיישן לחץ אוויר: (תחילת מצגת OOPDE-W10Lec20)

במודל הראשוני, אם היינו מוסיפים חיישן לחץ, היינו צריכים לשנות את הScheduler כדי שיידע לעדכן את המסך גם בנתוני לחץ.  
בזכות Observer, ההוספה קלה הרבה יותר ונמנע OCP.
![](Summeries/עיצוב/media/media/image80.png)

מדוע לא נכון לקבוע ש-MonitoringScreen יירש ישירות מ-Observer?. הסיבה היא שאם היינו עושים זאת, הוספת PressureSensor (כשהוא מדווח על נתונים שונים) הייתה מחייבת שינוי בקוד MonitoringScreen. המתאמים מאפשרים למסך להמשיך לעבוד כרגיל (באמצעות displayTemperature או displayPressure) בזמן שהמתאם מבצע את התרגום הנדרש ממתודת update() הגנרית.

## הפיכת Observer לגנרי (מצגת OOPDE-W10Lec20 שקף 10)

המעבר ל-Observer גנרי (השימוש ב-`T` כפרמטר טיפוס) נועד לפתור את הבעיה שנוצרה כאשר חיישן מגמת הלחץ (`PressureTrendSensor`) דרש להעביר עדכונים מטיפוס שונה:

הבעיה: חיישני הטמפרטורה והלחץ דיווחו על ערך מספרי (`int`). חיישן מגמת הלחץ (`PressureTrendSensor`) דיווח על טיפוס שונה (`Trend`).

- הפרה פוטנציאלית: אם נשאר עם ממשק Observer המוגדר לטיפוס ספציפי (למשל, `int update(int data)`), לא נוכל להשתמש באותה התבנית כדי להעביר עדכונים של `Trend`.
    

הפתרון: כדי שנוכל להשתמש באותה תבנית עבור חתימות שונות, הפכו את ה-Observer לגנרי.

הממשק `Observer` והמחלקה `Observable` הוגדרו להיות גנריים (`Observer<T>`, `Observable<T>`). כך, `PressureTrendSensor` יכול לשמש גם כ-`Observer<Integer>` (מקבל נתונים מספריים מחיישן הלחץ) וגם כ-`Observable<Trend>` (מוציא עדכוני מגמה).

- `PressureSensor` הפך ל-
```Java
Observable<Integer>
```
(או סוג מספרי אחר), והוא מוצג בתרשים.

- `PressureTrendSensor` (שמצוין בתרשים) הפך ל-`Observer<Integer>` (מקבל מספרים מחיישן הלחץ) וגם ל-`Observable<Trend>` (מוציא מגמה). זוהי מחלקה שהיא גם צרכנית וגם ספקית של שירותים/מידע.
    

הפיכת התבנית לגנרית איפשרה לפתור את הבעיה הזו, לשמור על עקרון OCP גם ברמת הטיפוסים, ולהמשיך להרחיב את המערכת בצורה גמישה.

הערה: לאן נעלמה `TemperatureSensor`? היא נמצאת באותה היררכיה כמו `PressureSensor` ופועלת באותה צורה (כ-`Observable<Integer>`). מכיוון שהתרשים הספציפי מתמקד בהדגמת השינוי בטיפוסים, הוא בוחר להציג רק את רכיבי הלחץ שמדגימים את הצורך והפתרון הגנרי.

**הבעיות שנפתרו:**

- הפרת [[DIP]] בין החיישנים לתצוגה - היא שחררה את החיישנים מהצורך להכיר את הצרכנים הקונקרטיים שלהם.
    
- נמנע [[OCP]] - לא עשינו ירושה ישירה של המסך מ-`Observer`, ובכך אנו מאפשרים הוספת מסכים נוספים בעתיד.
    

**מה הבעיות שנוצרו:**

- הפרת [[DIP]] בין החיישנים למתזמן - נפתור ע"י `AlarmClock`
    
- הפרת [[SRP]] של המתזמן - נפתור ע"י `AlarmClock`
    
- הפרת [[DIP]] בין האפליקציה לחומרה: `TemperatureSensor` (ההפשטה) עדיין תלויה ב-`Nimbus1_0Temperature` (הקונקרטי). - נפתור ע"י `Bridge`.
    
- הפרת [[OCP]] חדשה: החלפת חומרה תאלץ שינוי בקוד `TemperatureSensor`. - יעלם ע"י `Bridge`.
    
- הפרת ISP, זיהום ממשקים: `Nimbus1_0Temperature` הייתה מקושרת לכל `TemperatureSensor` ויכלה לגשת למידע שלא קשור לחומרה (כמו רשימת ה-Observers). - יעלם ע"י `Bridge`.
    
### מתאם (Adapter) בשילוב Observer

על מנת לנתק את `MonitoringScreen` (שיש לו מתודות ספציפיות כמו `displayTemperature`) מהממשק הגנרי של `Observer` (כמו `update(data:int)`), נעשה שימוש במתאם (`MS_TemperatureObserver`).

- המתאם מקבל את העדכון הגנרי (`update`) ומתרגם אותו למתודה הספציפית של המסך (`displayTemperature`).
    
- **גנריות:** התבנית שודרגה לשימוש גנרי (`Observer<T>`, `Observable<T>`) כדי לאפשר לחיישנים לדווח על טיפוסים שונים (לדוגמה, `int` או `Trend`).
    

### יישום חיישן מגמה (Observer-Observable)

`PressureTrendSensor` (חיישן מגמת הלחץ) ממחיש אובייקט שהוא **גם צרכן וגם ספק מידע**:

- הוא **Observer** – הוא נרשם ל-`PressureSensor` ומקבל ממנו עדכוני לחץ מספריים.
    
- הוא **Observable** – הוא מחשב את המגמה, ואם היא משתנה, הוא מפיץ עדכון מסוג `Trend` לצרכנים שלו (כמו המסך).
    

### קוד דוגמה (עדכון ב-Observable)
```Java
void check() {
    int temp = read();
    if (lastReading != temp){
        lastReading = temp;
        notifyObservers(lastReading); // קריאה גנרית לצופים
    }
}
```
**_החיישן כבר לא תלוי במסך הקונקרטי._**

### שאלות על תבנית Observer

- **מעבדה 11 (WMS 1-2), שקף 3:**
    
    - **נושא:** יישום Observer.
        
    - **תיאור:** נתונה מערכת מזג האוויר. רוצים להוסיף `WindSensor` ולהציג את הנתונים שלו ב-`MonitoringScreen`. כיצד יש לעדכן את התרשים?
        
- **מעבדה 11 (WMS 1-2), שקף 18:**
    
    - **נושא:** אובייקט שהוא גם Observer וגם Observable.
        
    - **תיאור:** רוצים להוסיף `HumiditySensor` ו-`HumidityTrendSensor`. חיישן המגמה צריך לקבל עדכונים מחיישן הלחות. כיצד נכון למדל את הקשר ביניהם?
        

**שאלות ממבחנים:**

- WMS ו-DIP: הדגש את תפקידו המרכזי של Observer ב-WMS: ניתוק התלות הישירה בין החיישנים למסך/לוגר, ובכך פתרון הפרות DIP ו-SRP. (תשפ"א א ב)
    
- תשפ"ד א ב שאלה 7 (מערכת מזג אוויר, הוספת `TemperatureTrendSensor`).
    
- תשפ"ג ב ב שאלה 8 (מערכת חדשות, תפקיד העיתונאי והמנוי).
    
- תשפ"ג ב ב שאלה 1 (ייעול קוד תיאום ב-`MonitoringScreen`).
    
- תשפ"ד א א שאלה 3 (ניתוק המתזמן מהמסך, הפרות SRP ו-DIP).
    
- תשפ"ה ב א שאלה 3א (בית חכם, עדכון סטטוס מכשירים).
    
- תשפ"ד ב א שאלה 3 (פורטל חדשות/נושאים).
    
---

**קודם:** [[Template Method]] **הבא:** [[AlarmClock]]

**חזרה ל:** [[מערכת ניטור מזג אוויר (WMS)]] **תוכן עניינים ראשי:** [[Summeries/עיצוב/תוכן עניינים]]